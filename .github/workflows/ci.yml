name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  # Frontend UI Library
  ui-library:
    name: UI Library - Build & Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint UI Library
        run: pnpm --filter ui-library lint

      - name: Test UI Library
        run: pnpm --filter ui-library test

      - name: Build UI Library
        run: pnpm --filter ui-library build

  # Frontend Search App
  search-app:
    name: Search App - Build & Test
    runs-on: ubuntu-latest
    needs: ui-library
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint Search App
        run: pnpm --filter search-app lint

      - name: Test Search App
        run: pnpm --filter search-app test

      - name: Build Search App
        run: pnpm --filter search-app build

  # BFF (NestJS)
  bff:
    name: BFF - Build & Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint BFF
        run: pnpm --filter bff lint

      - name: Unit Tests
        run: pnpm --filter bff test:unit

      - name: Integration Tests
        run: pnpm --filter bff test:integration

      - name: Build BFF
        run: pnpm --filter bff build

  # Backend (.NET)
  backend:
    name: Backend - Build & Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore dependencies
        run: dotnet restore packages/backend/Backend.sln

      - name: Build
        run: dotnet build packages/backend/Backend.sln --configuration Release --no-restore

      - name: Unit Tests
        run: dotnet test packages/backend/tests/Backend.Application.UnitTests/Backend.Application.UnitTests.csproj --configuration Release --no-build --verbosity normal

      - name: API Tests
        run: dotnet test packages/backend/tests/Backend.WebApi.ApiTests/Backend.WebApi.ApiTests.csproj --configuration Release --no-build --verbosity normal

      # Integration tests are skipped in CI as they require CosmosDB Emulator
      # In production CI, you would set up CosmosDB TestContainers or use emulator
      # - name: Integration Tests
      #   run: dotnet test packages/backend/tests/Backend.Infrastructure.IntegrationTests/Backend.Infrastructure.IntegrationTests.csproj --configuration Release --no-build --verbosity normal

  # All tests passed
  success:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs: [ui-library, search-app, bff, backend]
    steps:
      - name: Success
        run: echo "All checks passed successfully!"
